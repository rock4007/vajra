<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAJRA Test Suite</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            color: #ef4444;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #ef4444;
            border-radius: 5px;
        }
        .test-section h2 {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        .test-item {
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }
        .test-label {
            font-weight: 600;
            color: #333;
        }
        .btn {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #dc2626;
        }
        .btn-secondary {
            background: #667eea;
        }
        .btn-secondary:hover {
            background: #5568d3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 5px;
            color: #166534;
            font-size: 0.9em;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result.error {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #991b1b;
        }
        .status-online { color: #16a34a; font-weight: bold; }
        .status-offline { color: #dc2626; font-weight: bold; }
        .log-area {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-item {
            padding: 3px 0;
            border-bottom: 1px solid #374151;
        }
        .log-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è VAJRA Shakti Kavach - Test Suite</h1>

        <div class="test-section">
            <h2>üì± App Status</h2>
            <div class="test-item">
                <span class="test-label">Service Worker Support</span>
                <button class="btn" onclick="testServiceWorker()">Test</button>
                <div id="sw-result" class="result"></div>
            </div>
            <div class="test-item">
                <span class="test-label">Local Storage</span>
                <button class="btn" onclick="testLocalStorage()">Test</button>
                <div id="storage-result" class="result"></div>
            </div>
            <div class="test-item">
                <span class="test-label">IndexedDB Support</span>
                <button class="btn" onclick="testIndexedDB()">Test</button>
                <div id="idb-result" class="result"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìç Geolocation</h2>
            <div class="test-item">
                <span class="test-label">Get Current Location</span>
                <button class="btn btn-secondary" onclick="testLocation()">Test</button>
                <div id="location-result" class="result"></div>
            </div>
            <div class="test-item">
                <span class="test-label">Watch Position</span>
                <button class="btn btn-secondary" onclick="testWatchPosition()">Start</button>
                <button class="btn" onclick="stopWatchPosition()" style="margin-left:5px;">Stop</button>
                <div id="watch-result" class="result"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üîê Cryptography</h2>
            <div class="test-item">
                <span class="test-label">SHA-256 Hashing</span>
                <button class="btn" onclick="testSHA256()">Test</button>
                <div id="hash-result" class="result"></div>
            </div>
            <div class="test-item">
                <span class="test-label">Random Hash Generation</span>
                <button class="btn" onclick="testRandomHash()">Test</button>
                <div id="random-result" class="result"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üåê Network</h2>
            <div class="test-item">
                <span class="test-label">Server Health Check</span>
                <button class="btn" onclick="testServerHealth()">Test</button>
                <div id="health-result" class="result"></div>
            </div>
            <div class="test-item">
                <span class="test-label">Online Status</span>
                <span id="online-status" class="status-online">üü¢ Online</span>
            </div>
        </div>

        <div class="test-section">
            <h2>üíæ Data Storage</h2>
            <div class="test-item">
                <span class="test-label">Save Test Data</span>
                <button class="btn" onclick="testSaveData()">Test</button>
                <div id="save-result" class="result"></div>
            </div>
            <div class="test-item">
                <span class="test-label">Retrieve Test Data</span>
                <button class="btn" onclick="testRetrieveData()">Test</button>
                <div id="retrieve-result" class="result"></div>
            </div>
            <div class="test-item">
                <span class="test-label">Clear All Data</span>
                <button class="btn" onclick="testClearData()">Clear</button>
                <div id="clear-result" class="result"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üöÄ Run All Tests</h2>
            <button class="btn btn-secondary" onclick="runAllTests()" style="width:100%; padding:15px; font-size:1.1em;">Run All Tests</button>
            <div class="log-area" id="logArea"></div>
        </div>
    </div>

    <script>
        const logArea = document.getElementById('logArea');
        
        function log(message) {
            const item = document.createElement('div');
            item.className = 'log-item';
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(item);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function showResult(elementId, message, isError = false) {
            const elem = document.getElementById(elementId);
            elem.textContent = message;
            elem.className = 'result show' + (isError ? ' error' : '');
        }
        
        // Test Service Worker
        function testServiceWorker() {
            if ('serviceWorker' in navigator) {
                showResult('sw-result', '‚úì Service Worker supported. Attempting registration...');
                log('Testing Service Worker registration');
                navigator.serviceWorker.register('sw.js')
                    .then(reg => {
                        showResult('sw-result', '‚úì Service Worker registered successfully');
                        log('‚úì Service Worker registered');
                    })
                    .catch(err => {
                        showResult('sw-result', '‚úó Registration failed: ' + err.message, true);
                        log('‚úó Service Worker registration failed: ' + err.message);
                    });
            } else {
                showResult('sw-result', '‚úó Service Worker not supported', true);
                log('‚úó Service Worker not supported');
            }
        }
        
        // Test Local Storage
        function testLocalStorage() {
            try {
                const testKey = '__vajra_test_' + Date.now();
                const testValue = { test: 'data', timestamp: new Date().toISOString() };
                localStorage.setItem(testKey, JSON.stringify(testValue));
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                localStorage.removeItem(testKey);
                showResult('storage-result', '‚úì Local Storage working: ' + JSON.stringify(retrieved));
                log('‚úì Local Storage test passed');
            } catch (e) {
                showResult('storage-result', '‚úó Local Storage failed: ' + e.message, true);
                log('‚úó Local Storage failed: ' + e.message);
            }
        }
        
        // Test IndexedDB
        function testIndexedDB() {
            const IDB = window.indexedDB || window.webkitIndexedDB;
            if (!IDB) {
                showResult('idb-result', '‚úó IndexedDB not supported', true);
                log('‚úó IndexedDB not supported');
                return;
            }
            
            const request = IDB.open('VajraTest', 1);
            request.onerror = () => {
                showResult('idb-result', '‚úó IndexedDB failed: ' + request.error, true);
                log('‚úó IndexedDB test failed');
            };
            request.onsuccess = () => {
                showResult('idb-result', '‚úì IndexedDB available and working');
                log('‚úì IndexedDB test passed');
                request.result.close();
            };
        }
        
        // Test Geolocation
        function testLocation() {
            if (!navigator.geolocation) {
                showResult('location-result', '‚úó Geolocation not supported', true);
                log('‚úó Geolocation not supported');
                return;
            }
            
            showResult('location-result', 'Getting location...');
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const msg = `‚úì Lat: ${pos.coords.latitude.toFixed(6)}, Lng: ${pos.coords.longitude.toFixed(6)}, Accuracy: ${pos.coords.accuracy.toFixed(0)}m`;
                    showResult('location-result', msg);
                    log(msg);
                },
                err => {
                    showResult('location-result', '‚úó ' + err.message, true);
                    log('‚úó Geolocation error: ' + err.message);
                },
                { timeout: 10000 }
            );
        }
        
        let watchId = null;
        function testWatchPosition() {
            if (!navigator.geolocation) {
                showResult('watch-result', '‚úó Geolocation not supported', true);
                return;
            }
            showResult('watch-result', 'Watching position...');
            watchId = navigator.geolocation.watchPosition(
                pos => {
                    const msg = `‚úì Lat: ${pos.coords.latitude.toFixed(6)}, Lng: ${pos.coords.longitude.toFixed(6)}`;
                    showResult('watch-result', msg);
                    log(msg);
                },
                err => {
                    showResult('watch-result', '‚úó ' + err.message, true);
                    log('‚úó Watch position error: ' + err.message);
                }
            );
        }
        
        function stopWatchPosition() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                showResult('watch-result', 'Position watching stopped');
                log('Position watching stopped');
                watchId = null;
            }
        }
        
        // Test SHA-256
        function testSHA256() {
            if (!window.crypto || !window.crypto.subtle) {
                showResult('hash-result', '‚úó Web Crypto API not available', true);
                log('‚úó Web Crypto API not available');
                return;
            }
            
            const message = 'VAJRA Test Hash ' + Date.now();
            const encoder = new TextEncoder();
            window.crypto.subtle.digest('SHA-256', encoder.encode(message))
                .then(hashBuffer => {
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    showResult('hash-result', '‚úì SHA-256: ' + hashHex.slice(0, 32) + '...');
                    log('‚úì SHA-256 hash generated successfully');
                })
                .catch(err => {
                    showResult('hash-result', '‚úó ' + err.message, true);
                    log('‚úó SHA-256 error: ' + err.message);
                });
        }
        
        // Test Random Hash
        function testRandomHash() {
            const hash = btoa(Date.now() + Math.random()).slice(0, 64);
            showResult('random-result', '‚úì Hash: ' + hash);
            log('‚úì Random hash generated: ' + hash.slice(0, 32) + '...');
        }
        
        // Test Server Health
        function testServerHealth() {
            showResult('health-result', 'Checking server...');
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 5000);
            
            fetch('/health', { signal: controller.signal })
                .then(r => {
                    clearTimeout(timeout);
                    showResult('health-result', r.ok ? '‚úì Server online' : '‚úó Server error: ' + r.status);
                    log(r.ok ? '‚úì Server is online' : '‚úó Server returned error');
                })
                .catch(err => {
                    clearTimeout(timeout);
                    showResult('health-result', '‚úó Server unreachable (Offline mode active)', true);
                    log('‚ö†Ô∏è Server unreachable - offline mode active');
                });
        }
        
        // Test Save Data
        function testSaveData() {
            const testData = {
                type: 'TEST',
                timestamp: new Date().toISOString(),
                value: Math.random()
            };
            try {
                localStorage.setItem('__vajra_test_data__', JSON.stringify(testData));
                showResult('save-result', '‚úì Test data saved: ' + JSON.stringify(testData));
                log('‚úì Test data saved successfully');
            } catch (e) {
                showResult('save-result', '‚úó Save failed: ' + e.message, true);
                log('‚úó Save data failed: ' + e.message);
            }
        }
        
        // Test Retrieve Data
        function testRetrieveData() {
            try {
                const data = localStorage.getItem('__vajra_test_data__');
                if (data) {
                    showResult('retrieve-result', '‚úì Retrieved: ' + data);
                    log('‚úì Data retrieved successfully');
                } else {
                    showResult('retrieve-result', '‚ö†Ô∏è No test data found. Save test data first.', true);
                    log('‚ö†Ô∏è No test data found');
                }
            } catch (e) {
                showResult('retrieve-result', '‚úó Retrieve failed: ' + e.message, true);
                log('‚úó Data retrieval failed');
            }
        }
        
        // Test Clear Data
        function testClearData() {
            try {
                localStorage.removeItem('__vajra_test_data__');
                showResult('clear-result', '‚úì Test data cleared');
                log('‚úì Test data cleared');
            } catch (e) {
                showResult('clear-result', '‚úó Clear failed: ' + e.message, true);
                log('‚úó Clear data failed');
            }
        }
        
        // Run All Tests
        function runAllTests() {
            logArea.innerHTML = '';
            log('Starting all tests...');
            log('');
            
            setTimeout(() => { testServiceWorker(); }, 500);
            setTimeout(() => { testLocalStorage(); }, 1000);
            setTimeout(() => { testIndexedDB(); }, 1500);
            setTimeout(() => { testLocation(); }, 2000);
            setTimeout(() => { testSHA256(); }, 2500);
            setTimeout(() => { testRandomHash(); }, 3000);
            setTimeout(() => { testServerHealth(); }, 3500);
            setTimeout(() => { testSaveData(); }, 4000);
            setTimeout(() => { testRetrieveData(); }, 4500);
        }
        
        // Monitor online status
        function updateOnlineStatus() {
            const statusEl = document.getElementById('online-status');
            statusEl.textContent = navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline';
            statusEl.className = navigator.onLine ? 'status-online' : 'status-offline';
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Initial setup
        window.addEventListener('load', () => {
            updateOnlineStatus();
            log('Test suite loaded');
        });
    </script>
</body>
</html>
